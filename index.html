<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS â€“ Escritorio PROVSOFT</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --azul: #00416A;
      --resalte: #0c6cbd;
      --fondo: #f4f7fa;
      --card: #ffffff;
      --shadow: 0 4px 16px rgba(0,0,0,.15);
      --radius: 10px;
    }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--fondo);
      color: #111;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    header {
      background: var(--azul);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 20px;
      font-weight: 600;
      height: 50px;
    }
    nav {
      display: flex;
      gap: 12px;
    }
    nav button {
      background: var(--resalte);
      border: none;
      color: #fff;
      font-weight: 600;
      padding: 8px 14px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background .2s;
    }
    nav button:hover { background: #09518e; }
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 16px;
      padding: 16px;
      box-sizing: border-box;
    }
    .venta-area {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .busqueda {
      display: flex;
      padding: 10px;
      background: #e8eef3;
      gap: 8px;
      align-items: center;
    }
    .busqueda input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: var(--radius);
      font-size: 15px;
    }
    .tabla-wrap {
      flex: 1;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    thead {
      background: var(--azul);
      color: #fff;
      position: sticky;
      top: 0;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #ddd;
    }
    tbody tr:hover { background: #f2f6fb; }
    td:last-child { text-align: right; }
    .resumen {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 14px;
    }
    .resumen .info {
      font-size: 14px;
      color: #333;
    }
    .resumen img {
      display: block;
      margin: 20px auto;
      max-width: 180px;
      opacity: 0.9;
    }
    .totales {
      background: #e9eef3;
      border-radius: var(--radius);
      padding: 10px;
      margin-top: 10px;
    }
    .totales div {
      display: flex;
      justify-content: space-between;
      font-size: 15px;
      padding: 3px 0;
    }
    .totales .total {
      font-size: 20px;
      font-weight: 700;
      color: var(--resalte);
    }
.empty img {
  width: 280px;       /* tamaÃ±o mÃ¡s grande */
  max-width: 80%;
  opacity: 0.25;
  display: block;
  margin: 0 auto 10px auto;
}
.empty {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}
    .btn-cobrar {
  background: var(--ok, #1e8e3e);
  color: #fff;
  font-weight: 600;
  font-size: 16px;
  border: none;
  border-radius: var(--radius);
  padding: 10px;
  margin-top: 14px;
  cursor: pointer;
  transition: background 0.2s;
  width: 100%;
}
.btn-cobrar:hover { background: #15702c; }
.modal-buscar {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.45);
  justify-content: center;
  align-items: center;
  z-index: 999;
}
.modal-contenido {
  background: var(--card);
  border-radius: 14px;
  padding: 20px;
  width: 90%;
  max-width: 650px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  border-top: 6px solid var(--resalte);
}
.modal-contenido h3 {
  margin-top: 0;
  text-align: center;
  color: var(--azul);
}
.modal-contenido input {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
}
.modal-contenido table thead {
  background: var(--azul);
  color: white;
}
.modal-contenido th, .modal-contenido td {
  padding: 8px 10px;
  border-bottom: 1px solid #ddd;
}
.modal-contenido tr:hover {
  background: #e4efff;
}
.cerrar {
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  font-weight: 600;
  margin-top: 10px;
  cursor: pointer;
}
    @keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
  </style>
</head>
  <body>
  <!-- === LOGIN === -->
  <div id="pantallaLogin"
       style="display:flex;flex-direction:column;align-items:center;justify-content:center;
              height:100vh;background:linear-gradient(to right,#00416A,#E4E5E6);">
    <div style="background:white;padding:30px 40px;border-radius:12px;
                box-shadow:0 6px 18px rgba(0,0,0,.2);max-width:320px;width:90%;text-align:center;">
      <img src="logo_proveedora.webp" style="max-width:140px;margin-bottom:12px;">
      <h2 style="color:#00416A;margin:0 0 14px;">Iniciar SesiÃ³n</h2>
      <input id="loginUsuario" placeholder="Usuario"
             style="width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;">
      <input id="loginPassword" type="password" placeholder="ContraseÃ±a"
             style="width:100%;padding:10px;margin-bottom:14px;border-radius:8px;border:1px solid #ccc;">
      <button id="btnLogin"
              style="background:#0c6cbd;color:white;border:none;padding:10px 14px;border-radius:8px;
                     font-weight:600;cursor:pointer;width:100%;">Entrar</button>
      <p id="loginMsg"
         style="color:red;font-size:14px;margin-top:8px;display:none;">
         Usuario o contraseÃ±a incorrectos
      </p>
    </div>
  </div>

<div id="pantallaPOS" style="display:none; animation: fadeIn 0.4s ease;">
  <header>
    <nav>
      <button id="btnCorte">Corte de Caja</button>
      <button id="btnCancelar">Cancelar Venta</button>
      <button id="btnDescuento">Descuento</button>
      <button id="btnSalida">Salidas de Efectivo</button>
      <button id="btnBuscarProd" style="background:#ffc107;color:#111;font-weight:600;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;">ðŸ”Ž Buscar ArtÃ­culo</button>
    </nav>
    <div>ðŸ’¼ Punto de Venta PROVSOFT</div>
    <button id="btnLogout" style="background:#dc3545;color:#fff;border:none;padding:6px 12px;border-radius:8px;font-weight:600;cursor:pointer;">Cerrar sesiÃ³n</button>
  </header>

  <main>
    <section class="venta-area">
      <div class="busqueda">
        <input id="buscador" type="text" placeholder="ðŸ” Escribe o escanea cÃ³digo..." />
      </div>
      <div class="tabla-wrap" id="tablaWrap">
        <div class="empty" id="estadoVacio">
          <img src="logo_proveedora.webp" alt="Logo">
          <p>Esperando nueva venta...</p>
        </div>
        <table id="tablaVenta" style="display:none;">
          <thead>
            <tr>
              <th>Producto</th><th>Cantidad</th><th>Importe</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <aside class="resumen">
      <div>
        <div class="info">
          <div><b>Fecha:</b> <span id="fecha"></span></div>
          <div><b># Venta:</b> <span id="folio">0</span></div>
          <div><b>Usuario:</b> <span id="usuario">gerardo</span></div>
        </div>
        <img src="logo_proveedora.webp" alt="Logo">
      </div>
      <div class="totales">
        <div><span>Subtotal</span><span id="lblSubtotal">$0.00</span></div>
        <div><span>I.V.A.</span><span id="lblIVA">$0.00</span></div>
        <div class="total"><span>Total</span><span id="lblTotal">$0.00</span></div>
      </div>
      <button id="btnCobrar" class="btn-cobrar">ðŸ’° Cobrar</button>
    </aside>
  </main>
    <!-- === MODAL FLOTANTE DE BÃšSQUEDA === -->
<div id="modalBuscar" class="modal-buscar">
  <div class="modal-contenido">
    <h3>Buscar artÃ­culo</h3>
    <input id="inputBusquedaProd" type="text" placeholder="Escribe nombre o cÃ³digo..." />
    <table id="tablaBusqueda">
      <thead>
        <tr><th>CÃ³digo</th><th>DescripciÃ³n</th><th>Costo</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="cerrarModal" class="cerrar">Cerrar</button>
  </div>
</div>
  <!-- === MODAL DE COBRO === -->
<div id="modalCobro" class="modal-buscar">
  <div class="modal-contenido" style="max-width:480px">
    <h3>Procesar pago</h3>
    <label>MÃ©todo de pago:</label>
    <select id="metodoPago" style="width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;">
      <option value="efectivo">ðŸ’µ Efectivo</option>
      <option value="tarjeta">ðŸ’³ Tarjeta</option>
      <option value="mixto">ðŸ’° Mixto</option>
    </select>

    <div id="bloqueEfectivo">
      <label>Monto recibido:</label>
      <input id="montoRecibido" type="number" min="0" step="0.01" placeholder="0.00"
        style="width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;">
      <div style="text-align:right;font-size:16px;font-weight:600;">Cambio: <span id="lblCambio">$0.00</span></div>
    </div>

    <button id="btnConfirmarCobro" style="background:#1e8e3e;color:white;border:none;border-radius:8px;padding:10px 14px;font-weight:600;margin-top:14px;width:100%;cursor:pointer;">Confirmar cobro</button>
    <button id="cerrarCobro" class="cerrar">Cancelar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  where,
  addDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
  // === CONTROL DE SESIÃ“N ===
const usuarioGuardado = localStorage.getItem("usuarioPOS");
if (usuarioGuardado) {
  document.getElementById("usuario").textContent = usuarioGuardado;
  document.getElementById("pantallaLogin").style.display = "none";
  document.getElementById("pantallaPOS").style.display = "block";
}

// === LOGIN FIRESTORE ===
const pantallaLogin = document.getElementById("pantallaLogin");
const pantallaPOS = document.getElementById("pantallaPOS");
const btnLogin = document.getElementById("btnLogin");
const loginUsuario = document.getElementById("loginUsuario");
const loginPassword = document.getElementById("loginPassword");
const loginMsg = document.getElementById("loginMsg");

btnLogin.addEventListener("click", async () => {
  const user = loginUsuario.value.trim().toUpperCase();
  const pass = loginPassword.value.trim();
  if (!user || !pass) return;

  // Buscar en colecciÃ³n usuarios_ruta
  const q = query(
    collection(db, "usuarios_ruta"),
    where("usuario", "==", user),
    where("activo", "==", true)
  );
  const snap = await getDocs(q);

  if (snap.empty) {
    loginMsg.style.display = "block";
    loginMsg.textContent = "Usuario no encontrado.";
    return;
  }

  const data = snap.docs[0].data();
  if (data.password !== pass) {
    loginMsg.style.display = "block";
    loginMsg.textContent = "ContraseÃ±a incorrecta.";
    return;
  }

  // Si coincide
  localStorage.setItem("usuarioPOS", data.usuario);
  document.getElementById("usuario").textContent = data.usuario;
  pantallaLogin.style.display = "none";
  pantallaPOS.style.display = "block";
});


// === ELEMENTOS BÃSICOS ===
const buscador = document.getElementById("buscador");
const tbody = document.getElementById("tbody");
const lblSubtotal = document.getElementById("lblSubtotal");
const lblIVA = document.getElementById("lblIVA");
const lblTotal = document.getElementById("lblTotal");
const tablaVenta = document.getElementById("tablaVenta");
const estadoVacio = document.getElementById("estadoVacio");

let catalogo = [];
let carrito = [];

const money = n => "$" + (Number(n) || 0).toFixed(2);

// === CARGAR PRODUCTOS ===
async function cargarCatalogo() {
  const q = query(collection(db, "productos"), where("activo", "==", true));
  const snap = await getDocs(q);
  catalogo = snap.docs.map(d => {
    const x = d.data();
    return {
      id: d.id,
      nombre: x.concepto || "SIN NOMBRE",
      codigo: (x.codigoBarra || "").toString(),
      precio: Number(x.precioPublico || 0),
      codigosEquivalentes: x.codigosEquivalentes || []
    };
  });
  console.log("ðŸ“¦ Productos cargados:", catalogo.length);
}
await cargarCatalogo();

// === BUSCAR PRODUCTO ===
function buscarProd(q) {
  q = q.toLowerCase();
  return catalogo.find(p =>
    p.codigo === q ||
    (p.codigosEquivalentes && p.codigosEquivalentes.includes(q)) ||
    p.nombre.toLowerCase().includes(q)
  );
}
let folioActual = (() => {
  const fecha = new Date().toISOString().slice(0,10).replace(/-/g,"");
  const rand = Math.random().toString(36).substring(2, 8).toUpperCase();
  return `PDD-${fecha}-${rand}`;
})();
document.getElementById("folio").textContent = folioActual;
  
  // === RENDERIZAR TABLA ===
function render() {
  tbody.innerHTML = "";
  if (carrito.length === 0) {
    estadoVacio.style.display = "flex";
    tablaVenta.style.display = "none";
    lblSubtotal.textContent = lblIVA.textContent = lblTotal.textContent = "$0.00";
    return;
  }
  estadoVacio.style.display = "none";
  tablaVenta.style.display = "table";

  let subtotal = carrito.reduce((a, b) => a + b.importe, 0);
  const iva = subtotal * 0.16;
  const total = subtotal + iva;

  carrito.forEach(it => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td><b>${it.codigo}</b><br>${it.nombre}</td><td>${it.cantidad}</td><td>${money(it.importe)}</td>`;
    tbody.appendChild(tr);
  });

  lblSubtotal.textContent = money(subtotal);
  lblIVA.textContent = money(iva);
  lblTotal.textContent = money(total);
}

// === AÃ‘ADIR PRODUCTO DESDE BUSCADOR ===
buscador.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    const val = buscador.value.trim();
    if (!val) return;
    const prod = buscarProd(val);
    if (!prod) {
      alert("Producto no encontrado");
      buscador.value = "";
      return;
    }
    const ex = carrito.find(x => x.id === prod.id);
    if (ex) {
      ex.cantidad += 1;
      ex.importe = ex.cantidad * prod.precio;
    } else {
      carrito.push({ ...prod, cantidad: 1, importe: prod.precio });
    }
    buscador.value = "";
    render();
  }
});

// === FECHA ===
document.getElementById("fecha").textContent = new Date().toLocaleDateString("es-MX");

// === MODAL DE COBRO ===
const modalCobro = document.getElementById("modalCobro");
const metodoPago = document.getElementById("metodoPago");
const montoRecibido = document.getElementById("montoRecibido");
const lblCambio = document.getElementById("lblCambio");
const btnConfirmarCobro = document.getElementById("btnConfirmarCobro");
const btnCerrarCobro = document.getElementById("cerrarCobro");

// Abrir modal al presionar Cobrar
document.getElementById("btnCobrar").addEventListener("click", () => {
  if (carrito.length === 0) return alert("No hay productos en la venta.");
  modalCobro.style.display = "flex";
  montoRecibido.value = "";
  lblCambio.textContent = "$0.00";
});

// Cerrar modal
btnCerrarCobro.addEventListener("click", () => modalCobro.style.display = "none");

// Calcular cambio dinÃ¡mico
montoRecibido.addEventListener("input", () => {
  const total = carrito.reduce((a, b) => a + b.importe, 0) * 1.16;
  const recibido = parseFloat(montoRecibido.value) || 0;
  const cambio = Math.max(0, recibido - total);
  lblCambio.textContent = "$" + cambio.toFixed(2);
});

// Confirmar cobro
btnConfirmarCobro.addEventListener("click", async () => {
  const total = carrito.reduce((a, b) => a + b.importe, 0) * 1.16;
  const recibido = parseFloat(montoRecibido.value) || 0;

  if (metodoPago.value === "efectivo" && recibido < total) {
    alert("El monto recibido es insuficiente.");
    return;
  }

  // Generar folio Ãºnico
  const generarFolio = () => {
    const fecha = new Date().toISOString().slice(0,10).replace(/-/g,"");
    const rand = Math.random().toString(36).substring(2, 8).toUpperCase();
    return `PDD-${fecha}-${rand}`;
  };
 const folio = folioActual;

  const venta = {
    folio,
    fecha: new Date().toISOString(),
    usuario: document.getElementById("usuario").textContent,
    metodoPago: metodoPago.value,
    total,
    montoRecibido: metodoPago.value === "efectivo" ? recibido : total,
    cambio: metodoPago.value === "efectivo" ? (recibido - total) : 0,
    items: carrito.map(x => ({
      producto: x.nombre,
      cantidad: x.cantidad,
      precio: x.precio,
      importe: x.importe,
    })),
  };

  try {
    await addDoc(collection(db, "ventas"), venta);
    alert(`âœ… Venta registrada correctamente.\nFolio: ${folio}`);
    document.getElementById("folio").textContent = folio;
    modalCobro.style.display = "none";
    carrito = [];
    render();
  } catch (e) {
    console.error(e);
    alert("Error al registrar el cobro.");
  }
});


// Cerrar modal con clic fuera o tecla ESC
window.addEventListener("click", e => { if (e.target === modalCobro) modalCobro.style.display = "none"; });
window.addEventListener("keydown", e => { if (e.key === "Escape") modalCobro.style.display = "none"; });

// === MODAL DE BÃšSQUEDA ===
const modal = document.getElementById("modalBuscar");
const inputBusquedaProd = document.getElementById("inputBusquedaProd");
const tablaBusqueda = document.getElementById("tablaBusqueda").querySelector("tbody");
const btnBuscarProd = document.getElementById("btnBuscarProd");
const btnCerrarModal = document.getElementById("cerrarModal");

btnBuscarProd.addEventListener("click", () => {
  modal.style.display = "flex";
  inputBusquedaProd.focus();
  tablaBusqueda.innerHTML = "";
});

btnCerrarModal.addEventListener("click", () => modal.style.display = "none");

inputBusquedaProd.addEventListener("input", () => {
  const val = inputBusquedaProd.value.trim().toLowerCase();
  tablaBusqueda.innerHTML = "";
  if (!val) return;
  const resultados = catalogo.filter(
    p => p.nombre.toLowerCase().includes(val) || (p.codigo && p.codigo.toLowerCase().includes(val))
  );
  resultados.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${p.codigo}</td><td>${p.nombre}</td><td>$${p.precio.toFixed(2)}</td>`;
    tr.addEventListener("click", () => {
      const ex = carrito.find(x => x.id === p.id);
      if (ex) {
        ex.cantidad += 1;
        ex.importe = ex.cantidad * p.precio;
      } else {
        carrito.push({ ...p, cantidad: 1, importe: p.precio });
      }
      render();
      modal.style.display = "none";
    });
    tablaBusqueda.appendChild(tr);
  });
});

window.addEventListener("click", e => { if (e.target === modal) modal.style.display = "none"; });
window.addEventListener("keydown", e => { if (e.key === "Escape") modal.style.display = "none"; });
  // === CERRAR SESIÃ“N ===
const btnLogout = document.getElementById("btnLogout");
btnLogout.addEventListener("click", () => {
  localStorage.removeItem("usuarioPOS");
  document.getElementById("pantallaPOS").style.display = "none";
  document.getElementById("pantallaLogin").style.display = "flex";
});
</script>
</body>
</html>
