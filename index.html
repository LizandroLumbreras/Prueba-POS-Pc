<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS â€“ Escritorio PROVSOFT</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --azul: #00416A;
      --resalte: #0c6cbd;
      --fondo: #f4f7fa;
      --card: #ffffff;
      --shadow: 0 4px 16px rgba(0,0,0,.15);
      --radius: 10px;
    }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--fondo);
      color: #111;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    header {
      background: var(--azul);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 20px;
      font-weight: 600;
      height: 50px;
    }
    nav {
      display: flex;
      gap: 12px;
    }
    nav button {
      background: var(--resalte);
      border: none;
      color: #fff;
      font-weight: 600;
      padding: 8px 14px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background .2s;
    }
    nav button:hover { background: #09518e; }
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 16px;
      padding: 16px;
      box-sizing: border-box;
    }
    .venta-area {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .busqueda {
      display: flex;
      padding: 10px;
      background: #e8eef3;
      gap: 8px;
      align-items: center;
    }
    .busqueda input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: var(--radius);
      font-size: 15px;
    }
    .tabla-wrap {
      flex: 1;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    thead {
      background: var(--azul);
      color: #fff;
      position: sticky;
      top: 0;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #ddd;
    }
    tbody tr:hover { background: #f2f6fb; }
    td:last-child { text-align: right; }
    .resumen {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 14px;
    }
    .resumen .info {
      font-size: 14px;
      color: #333;
    }
    .resumen img {
      display: block;
      margin: 20px auto;
      max-width: 180px;
      opacity: 0.9;
    }
    .totales {
      background: #e9eef3;
      border-radius: var(--radius);
      padding: 10px;
      margin-top: 10px;
    }
    .totales div {
      display: flex;
      justify-content: space-between;
      font-size: 15px;
      padding: 3px 0;
    }
    .totales .total {
      font-size: 20px;
      font-weight: 700;
      color: var(--resalte);
    }
.empty img {
  width: 280px;       /* tamaÃ±o mÃ¡s grande */
  max-width: 80%;
  opacity: 0.25;
  display: block;
  margin: 0 auto 10px auto;
}
.empty {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}
    .btn-cobrar {
  background: var(--ok, #1e8e3e);
  color: #fff;
  font-weight: 600;
  font-size: 16px;
  border: none;
  border-radius: var(--radius);
  padding: 10px;
  margin-top: 14px;
  cursor: pointer;
  transition: background 0.2s;
  width: 100%;
}
.btn-cobrar:hover { background: #15702c; }
.modal-buscar {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.45);
  justify-content: center;
  align-items: center;
  z-index: 999;
}
.modal-contenido {
  background: var(--card);
  border-radius: 14px;
  padding: 20px;
  width: 90%;
  max-width: 650px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  border-top: 6px solid var(--resalte);
}
.modal-contenido h3 {
  margin-top: 0;
  text-align: center;
  color: var(--azul);
}
.modal-contenido input {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
}
.modal-contenido table thead {
  background: var(--azul);
  color: white;
}
.modal-contenido th, .modal-contenido td {
  padding: 8px 10px;
  border-bottom: 1px solid #ddd;
}
.modal-contenido tr:hover {
  background: #e4efff;
}
.cerrar {
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  font-weight: 600;
  margin-top: 10px;
  cursor: pointer;
}
  </style>
</head>
<body>
<header>
  <nav>
    <button id="btnCorte">Corte de Caja</button>
    <button id="btnCancelar">Cancelar Venta</button>
    <button id="btnDescuento">Descuento</button>
    <button id="btnSalida">Salidas de Efectivo</button>
    <button id="btnBuscarProd" style="background:#ffc107;color:#111;font-weight:600;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;">ðŸ”Ž Buscar ArtÃ­culo</button>
  </nav>
  <div>ðŸ’¼ Punto de Venta PROVSOFT</div>
</header>

<main>
  <section class="venta-area">
    <div class="busqueda">
      <input id="buscador" type="text" placeholder="ðŸ” Escribe o escanea cÃ³digo..." />
    </div>
    <div class="tabla-wrap" id="tablaWrap">
      <div class="empty" id="estadoVacio">
        <img src="logo_proveedora.webp" alt="Logo">
        <p>Esperando nueva venta...</p>
      </div>
      <table id="tablaVenta" style="display:none;">
        <thead>
          <tr>
            <th>Producto</th><th>Cantidad</th><th>Importe</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <aside class="resumen">
    <div>
      <div class="info">
        <div><b>Fecha:</b> <span id="fecha"></span></div>
        <div><b># Venta:</b> <span id="folio">0</span></div>
        <div><b>Usuario:</b> <span id="usuario">gerardo</span></div>
      </div>
      <img src="logo_proveedora.webp" alt="Logo">
    </div>
    <div class="totales">
      <div><span>Subtotal</span><span id="lblSubtotal">$0.00</span></div>
      <div><span>I.V.A.</span><span id="lblIVA">$0.00</span></div>
      <div class="total"><span>Total</span><span id="lblTotal">$0.00</span></div>
    </div>
    <button id="btnCobrar" class="btn-cobrar">ðŸ’° Cobrar</button>
  </aside>
</main>
    <!-- === MODAL FLOTANTE DE BÃšSQUEDA === -->
<div id="modalBuscar" class="modal-buscar">
  <div class="modal-contenido">
    <h3>Buscar artÃ­culo</h3>
    <input id="inputBusquedaProd" type="text" placeholder="Escribe nombre o cÃ³digo..." />
    <table id="tablaBusqueda">
      <thead>
        <tr><th>CÃ³digo</th><th>DescripciÃ³n</th><th>Costo</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="cerrarModal" class="cerrar">Cerrar</button>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  where,
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const buscador = document.getElementById("buscador");
const tbody = document.getElementById("tbody");
const lblSubtotal = document.getElementById("lblSubtotal");
const lblIVA = document.getElementById("lblIVA");
const lblTotal = document.getElementById("lblTotal");
const tablaVenta = document.getElementById("tablaVenta");
const estadoVacio = document.getElementById("estadoVacio");

let catalogo = [];
let carrito = [];

const money = (n) => "$" + (Number(n) || 0).toFixed(2);

// --- CARGAR PRODUCTOS DESDE FIRESTORE ---
async function cargarCatalogo() {
  const q = query(collection(db, "productos"), where("activo", "==", true));
  const snap = await getDocs(q);
  catalogo = [];
  snap.forEach((d) => {
    const x = d.data();
    catalogo.push({
      id: d.id,
      nombre: x.concepto || "SIN NOMBRE",
      codigo: (x.codigoBarra || "").toString(),
      precio: Number(x.precioPublico || 0),
      codigosEquivalentes: x.codigosEquivalentes || [],
    });
  });
  console.log("ðŸ“¦ Productos cargados:", catalogo.length);
}
await cargarCatalogo();

// --- BUSCAR PRODUCTO ---
function buscarProd(q) {
  q = q.toLowerCase();
  return catalogo.find(
    (p) =>
      p.codigo === q ||
      (p.codigosEquivalentes && p.codigosEquivalentes.includes(q)) ||
      p.nombre.toLowerCase().includes(q)
  );
}

// --- ACTUALIZAR TABLA ---
function render() {
  tbody.innerHTML = "";
  if (carrito.length === 0) {
    estadoVacio.style.display = "flex";
    tablaVenta.style.display = "none";
    lblSubtotal.textContent = lblIVA.textContent = lblTotal.textContent = "$0.00";
    return;
  }
  estadoVacio.style.display = "none";
  tablaVenta.style.display = "table";
  let subtotal = 0;
  carrito.forEach((it) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${it.nombre}</td><td>${it.cantidad}</td><td>${money(
      it.importe
    )}</td>`;
    tbody.appendChild(tr);
    subtotal += it.importe;
  });
  const iva = subtotal * 0.16;
  const total = subtotal + iva;
  lblSubtotal.textContent = money(subtotal);
  lblIVA.textContent = money(iva);
  lblTotal.textContent = money(total);
}

// --- ESCUCHAR ENTER Y AGREGAR PRODUCTO ---
buscador.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    const val = buscador.value.trim();
    if (!val) return;
    const prod = buscarProd(val);
    if (!prod) {
      alert("Producto no encontrado");
      buscador.value = "";
      return;
    }
    const ex = carrito.find((x) => x.id === prod.id);
    if (ex) {
      ex.cantidad += 1;
      ex.importe = ex.cantidad * prod.precio;
    } else {
      carrito.push({ ...prod, cantidad: 1, importe: prod.precio });
    }
    buscador.value = "";
    render();
  }
});

// --- FECHA ---
document.getElementById("fecha").textContent =
  new Date().toLocaleDateString("es-MX");
  // --- BOTÃ“N COBRAR ---
document.getElementById("btnCobrar").addEventListener("click", async () => {
  if (carrito.length === 0) {
    alert("No hay productos en la venta.");
    return;
  }

  const venta = {
    fecha: new Date().toISOString(),
    usuario: document.getElementById("usuario").textContent,
    total: carrito.reduce((a, b) => a + b.importe, 0) * 1.16,
    items: carrito.map((x) => ({
      producto: x.nombre,
      cantidad: x.cantidad,
      precio: x.precio,
      importe: x.importe,
    })),
  };

  try {
    const { addDoc, collection } = await import(
      "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"
    );
    await addDoc(collection(db, "ventas"), venta);
    alert("âœ… Venta registrada correctamente.");

    carrito = [];
    render();
  } catch (e) {
    console.error(e);
    alert("Error al registrar la venta.");
  }
});
  // === MODAL DE BÃšSQUEDA DE PRODUCTOS ===
const modal = document.getElementById("modalBuscar");
const inputBusquedaProd = document.getElementById("inputBusquedaProd");
const tablaBusqueda = document.getElementById("tablaBusqueda").querySelector("tbody");
const btnBuscarProd = document.getElementById("btnBuscarProd");
const btnCerrarModal = document.getElementById("cerrarModal");

btnBuscarProd.addEventListener("click", () => {
  modal.style.display = "flex";
  inputBusquedaProd.focus();
  tablaBusqueda.innerHTML = "";
});

btnCerrarModal.addEventListener("click", () => {
  modal.style.display = "none";
});

// Buscar en catÃ¡logo mientras se escribe
inputBusquedaProd.addEventListener("input", () => {
  const val = inputBusquedaProd.value.trim().toLowerCase();
  tablaBusqueda.innerHTML = "";
  if (!val) return;
  const resultados = catalogo.filter(
    (p) =>
      p.nombre.toLowerCase().includes(val) ||
      (p.codigo && p.codigo.toLowerCase().includes(val))
  );
  resultados.forEach((p) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${p.codigo}</td><td>${p.nombre}</td><td>$${p.precio.toFixed(2)}</td>`;
    tr.addEventListener("click", () => {
      const ex = carrito.find((x) => x.id === p.id);
      if (ex) {
        ex.cantidad += 1;
        ex.importe = ex.cantidad * p.precio;
      } else {
        carrito.push({ ...p, cantidad: 1, importe: p.precio });
      }
      render();
      modal.style.display = "none";
      inputBusquedaProd.value = "";
    });
    tablaBusqueda.appendChild(tr);
  });
});

// Cerrar modal si se hace clic fuera
window.addEventListener("click", (e) => {
  if (e.target === modal) modal.style.display = "none";
});
  // Cerrar modal con tecla ESC
window.addEventListener("keydown", (e) => {
  if (e.key === "Escape") modal.style.display = "none";
});
</script>
</body>
</html>
